# Maut Backend To-Do List

## Phase 1: Core Backend API & Data Model Implementation (v0)

- [x] **Task 1:** Define overall project structure and create `com.maut.core.modules.projectspecification.v0_architecture_proposal.md`.
  - Status: Done
  - Deliverable: `com.maut.core.modules.projectspecification.v0_architecture_proposal.md`
- [x] **Task 2:** Implement Maut Platform Backend Data Models (Section 3 of `com.maut.core.modules.projectspecification.v0_project_spec.md`).
  - [x] ClientApplication Model (`com.maut.core.modules.clientapplication.model.ClientApplication`)
  - [x] MautUser Model (`com.maut.core.modules.user.model.MautUser`)
  - [x] UserWallet Model (`com.maut.core.modules.wallet.model.UserWallet`)
  - [x] UserAuthenticator Model (`com.maut.core.modules.authenticator.model.UserAuthenticator`)
- [ ] **Task 3:** Implement Maut Platform Backend API Definitions (Section 2 of `com.maut.core.modules.projectspecification.v0_project_spec.md`).
  - [x] POST /v1/session
  - [x] POST /v1/wallet/enroll (Core structure implemented; Turnkey/Auth placeholders)
  - [x] POST /v1/authenticators/initiate-passkey-registration (Core structure implemented; Turnkey/Auth placeholders)
  - [x] POST /v1/authenticators/complete-passkey-registration (Core structure implemented; Turnkey/Auth placeholders; DB migration for new fields created)
  - [x] POST /v1/policies/apply-signing-policy (Core structure implemented; Turnkey/Auth placeholders)
  - [x] GET /v1/wallet/details (Core structure implemented; Turnkey/Auth placeholders)
  - [x] POST /v1/transactions/initiate-signing (Core structure implemented; Turnkey/Auth placeholders)
  - [x] POST /v1/activities/:activityId/submit-user-approval (Core structure implemented; Turnkey/Auth placeholders)
  - [x] GET /v1/activities/:activityId/status (Core structure implemented; Turnkey/Auth placeholders)
  - [x] GET /v1/activities (placeholder logic implemented)
  - [x] GET /v1/passkeys (placeholder logic implemented)
  - [x] DELETE /v1/passkeys/:passkeyId (placeholder logic implemented)
- [x] **Task 4:** Set up initial database migrations for the new models using Flyway. (Core tables created: `client_applications`, `maut_users`, `user_authenticators`, `user_wallets`)
- [x] **Task 5:** Implement JSON 404 error response
  - [x] Create `ApiErrorResponse.java` DTO
  - [x] Implement `GlobalExceptionHandler.java` with `NoHandlerFoundException` handler
  - [x] Update `application.yml` to enable `NoHandlerFoundException` and configure resource mappings
- [ ] **Task 6:** Write unit and integration tests for all new services and controllers.
    - [x] Unit tests for `AuthenticatorController.java` (Initial structure and basic tests created)
    - [ ] Unit tests for `AuthenticatorServiceImpl.java`
        - [x] `initiatePasskeyRegistration` (initial placeholder tests)  // Refers to pre-Turnkey tests
        - [x] `listPasskeys` (comprehensive tests)
        - [x] `deletePasskey` (tests for current logic)
        - [x] `completePasskeyRegistration` (comprehensive tests for current logic, pre-Turnkey)
        - [x] `verifyPasskeyAssertion` (Placeholder implementation in AuthenticatorServiceImpl done)
        - [x] `findAndValidateUserAuthenticator` (Method implemented in AuthenticatorServiceImpl)
    - [x] Unit tests for `ActivityController.java` (Completed)
- [ ] **Task 7:** Begin Turnkey API client integration.
    - [x] Define Turnkey client interface and DTOs. (Completed)
    - [x] Implement Turnkey client methods for passkey registration (initiate/complete). (Completed)
    - [x] Implement Turnkey client method for passkey assertion verification. (Completed)
    - [ ] `AuthenticatorServiceImpl` Turnkey Integration & Testing:
        - **`initiatePasskeyRegistration`**:
            - [x] Integrate Turnkey client into `AuthenticatorServiceImpl`.
            - [x] Update unit tests in `AuthenticatorServiceImplTest.java` (Turnkey integration and lint errors resolved).
            - [x] Run updated tests for `initiatePasskeyRegistration`.
        - **`completePasskeyRegistration`**:
            - [x] Integrate Turnkey client into `AuthenticatorServiceImpl`.
            - [x] Update unit tests in `AuthenticatorServiceImplTest.java`.
            - [x] Run updated tests for `completePasskeyRegistration`.
        - **`verifyPasskeyAssertion`**:
            - [x] Integrate Turnkey client into `AuthenticatorServiceImpl`.
            - [x] Update unit tests in `AuthenticatorServiceImplTest.java`.
            - [x] Run updated tests for `verifyPasskeyAssertion`.
    - [ ] General test file cleanup:
        - [ ] Clean up unused imports in `AuthenticatorServiceImplTest.java` once all test sections are active and tests pass.
- [ ] **Task 8:** Hello Module Enhancements
  - [x] Update `HelloMessageScheduler` cron schedule in `application-config.json` to run once per hour (`0 0 * * * ?`).
  - [x] Expand `RANDOM_GREETINGS` list in `HelloMessageService.java` with 40 additional greetings.
- [x] **Task 9:** Create Flyway migration script to add `last_used_at` (TIMESTAMP WITH TIME ZONE, nullable) column to `user_authenticators` table.
- [ ] **Task 10:** Write comprehensive unit tests in `AuthenticatorServiceImplTest.java` for `verifyPasskeyAssertion` (success, Turnkey failure, authenticator not found, wallet issues, Turnkey client exceptions, input validation).
- [x] **Task 11:** Ensure `UserAuthenticator.lastUsedAt` is updated and saved after successful verification in `verifyPasskeyAssertion`.

- [ ] **Task 12:** Implement Admin API for Client Application Management.
  - [x] `POST /v1/admin/client-applications`: Create a new client application (given a name, returns ID and secret).
    - Status: Implemented, currently unauthenticated.
    - TODO: Add authentication/authorization to this endpoint.
